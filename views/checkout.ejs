<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShopEase - Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
    <!-- Navigation (same as index.html) -->
    <% if (session.userData ) { %>
        <%- include('./partial/nav_logged.ejs')%>
    <% } else { %>
        <%- include('./partial/nav.ejs')%>
    <% } %>
    <!-- Checkout Section -->
    <section class="checkout py-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h4 class="mb-0">Checkout</h4>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-pills mb-4" id="checkoutTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="shipping-tab" data-bs-toggle="pill"
                                        data-bs-target="#shipping" type="button">
                                        <span class="step-number">1</span> Shipping
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="payment-tab" data-bs-toggle="pill"
                                        data-bs-target="#payment" type="button">
                                        <span class="step-number">2</span> Payment
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="review-tab" data-bs-toggle="pill"
                                        data-bs-target="#review" type="button">
                                        <span class="step-number">3</span> Review
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="checkoutTabsContent">
                                <!-- Shipping Tab -->
                                <div class="tab-pane fade show active" id="shipping" role="tabpanel">
                                    <h5 class="mb-4">Shipping Information</h5>

                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="firstName" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="firstName" required />
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="lastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="lastName" required />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                    <label for="shippingAddress" class="form-label">Shipping Address</label>
                                    <input type="text" 
                                            class="form-control" 
                                            id="shippingAddress" 
                                            name="shippingAddress"
                                            required
                                            placeholder="5th settlement, Cairo">
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-5 mb-3">
                                            <label for="country" class="form-label">Country</label>
                                            <input type="text" class="form-control" id="country" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="state" class="form-label">State</label>
                                            <input type="text" class="form-control" id="state" required />
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="zip" class="form-label">ZIP Code</label>
                                            <input type="text" class="form-control" id="zip" required />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" required />
                                    </div>

                                    <div class="mb-3 form-check">
                                        
                                    </div>

                                    <div class="d-flex justify-content-between mt-4">
                                        <button class="btn btn-outline-secondary" id="backToCartBtn">
                                            <i class="fas fa-arrow-left me-2"></i>Back to Cart
                                        </button>
                                        <button class="btn btn-primary" id="continueToPaymentBtn">
                                            Continue to Payment
                                            <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="payment" role="tabpanel">
                                    <h5 class="mb-4">Payment Method</h5>

                                    <div class="mb-4">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="paymentMethod"
                                                id="creditCard" checked />
                                            <label class="form-check-label" for="creditCard">
                                                Credit/Debit Card
                                            </label>
                                        </div>

                                        <div class="card-payment-form" id="cardPaymentForm">
                                            <div class="mb-3">
                                                <label for="cardNumber" class="form-label">Card Number</label>
                                                <input type="text" class="form-control" id="cardNumber"
                                                    />
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6 mb-3">
                                                    <label for="cardName" class="form-label">Name on Card</label>
                                                    <input type="text" class="form-control" id="cardName" />
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label for="cardExpiry" class="form-label">Expiry Date</label>
                                                    <input type="text" class="form-control" id="cardExpiry"
                                                        placeholder="MM/YY" />
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label for="cardCvv" class="form-label">CVV</label>
                                                    <input type="text" class="form-control" id="cardCvv"
                                                        placeholder="123" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="paymentMethod"
                                                id="bankTransfer" />
                                            <label class="form-check-label" for="bankTransfer">
                                                Cash On Delivery
                                            </label>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between mt-4">
                                        <button class="btn btn-outline-secondary" id="backToShippingBtn">
                                            <i class="fas fa-arrow-left me-2"></i>Back to Shipping
                                        </button>
                                        <button class="btn btn-primary" id="continueToReviewBtn">
                                            Continue to Review
                                            <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="review" role="tabpanel">
                                    <h5 class="mb-4">Review Your Order</h5>

                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Order Summary</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Price</th>
                                                            <th>Qty</th>
                                                            <th>Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% items.forEach(item => { %>
                                                            <tr>
                                                                <td><%= item.name %></td>
                                                                <td>$<%= Number(item.price).toFixed(2) %></td>
                                                                <td><%= item.quantity %></td>
                                                                <td>$<%= (Number(item.price) * Number(item.quantity)).toFixed(2) %></td>
                                                            </tr>
                                                            <% }) %>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div class="order-totals">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>$<%= subtotal.toFixed(2) %></span>
                                                    
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span id = shipfee>$<%= shipping.toFixed(2) %></span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>$<%= tax.toFixed(2) %></span>
                                                </div>
                                                <hr />
                                                <div class="d-flex justify-content-between mb-3">
                                                    <h5 id = "totalll">$<%= total.toFixed(2) %></h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check mb-4">
                                        <input class="form-check-input" type="checkbox" id="agreeTerms" required />
                                        <label class="form-check-label" for="agreeTerms">
                                            I agree to the <a href="#">Terms and Conditions</a> and
                                            <a href="#">Privacy Policy</a>
                                        </label>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-outline-secondary" id="backToPaymentBtn">
                                            <i class="fas fa-arrow-left me-2"></i>Back to Payment
                                        </button>
                                        <button class="btn btn-success" id="placeOrderBtn">
                                            <i class="fas fa-check me-2"></i>Place Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Order Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="order-summary-items">
                                    <% if (items && items.length) { %>
                                        <% items.forEach(item => { %>
                                        <div class="d-flex mb-3">
                                            <div class="order-item-img me-3">
                                                <img src="/assets/<%= item.image || '/assets/default-product.jpg' %>" alt="<%= item.name %>" class="img-thumbnail" style="width: 100px;"/>
                                            </div>
                                            <div class="order-item-details">
                                                <h6 class="mb-1"><%= item.name %></h6>
                                                <p class="text-muted mb-0">Qty: <%= item.quantity %></p>
                                            </div>
                                            <div class="order-item-price ms-auto">$<%= (item.price * item.quantity).toFixed(2) %></div>
                                        </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p>Your cart is empty</p>
                                    <% } %>
                                </div>
                    
                                <hr />
                    
                                <div class="order-summary-totals">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal</span>
                                        <span id = subtotall>$<%= (subtotal || 0).toFixed(2) %></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Shipping</span>
                                        <span id="shippping">$00.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tax</span>
                                        <span id = "taxx">$<%= (tax || 0).toFixed(2) %></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>discount</span>
                                        <span> $<%= (discount || 0).toFixed(2) %></span>
                                    </div>
                                    <hr />
                                    <div class="d-flex justify-content-between mb-3">
                                        <h5>Total</h5>
                                        <h5 id = "totall">$<%= (total || 0).toFixed(2) %></h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-body">
                            <h6 class="mb-3">Need Help?</h6>
                            <p>
                                Contact our customer support team for assistance with your
                                order.
                            </p>
                            <p><i class="fas fa-phone me-2"></i> (+20)0106155539</p>
                            <p><i class="fas fa-envelope me-2"></i> support@shopease.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer (same as index.html) -->
    <%- include('./partial/footer.ejs')%>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/cart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const cardPaymentForm = document.getElementById('cardPaymentForm');
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
        const backToCartBtn = document.getElementById('backToCartBtn');

        backToCartBtn.addEventListener('click', function () {
            window.location.href = '/cart';
        });
        
        paymentRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                cardPaymentForm.style.display = 
                    this.value === 'Credit/Debit Card' ? 'block' : 'none';
            });
        });

        placeOrderBtn.addEventListener('click', async function() {
            try {
                const shippingAddress = document.getElementById('shippingAddress').value.trim();
                const paymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
                
                if (!shippingAddress || !paymentRadio) {
                    throw new Error('Please fill out all required fields');
                }


                const paymentMethod = paymentRadio.value;
                const paymentDetails = {};

                if (paymentMethod === 'Credit/Debit Card') {
                    paymentDetails.cardNumber = document.getElementById('cardNumber').value.trim();
                    paymentDetails.cardName = document.getElementById('cardName').value.trim();
                    paymentDetails.cardExpiry = document.getElementById('cardExpiry').value.trim();
                    paymentDetails.cardCvv = document.getElementById('cardCvv').value.trim();

                    if (!paymentDetails.cardNumber || !paymentDetails.cardName || 
                        !paymentDetails.cardExpiry || !paymentDetails.cardCvv) {
                        throw new Error('Please complete all card details');
                    }
                }

                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing';

                const response = await fetch('/orders/place-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shippingAddress,
                        paymentMethod,
                        paymentDetails: paymentMethod === 'Credit/Debit Card' ? paymentDetails : undefined
                    }),
                    credentials: 'include'
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Order failed');
                }

                window.location.href = result.redirect;

            } catch (error) {
                console.error('Checkout Error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = '<i class="fas fa-check me-2"></i> Place Order';
            }
        });
    });
    </script>
</body>

</html>